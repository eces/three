// Generated by CoffeeScript 1.6.3
(function(){var e;e=require("../db.js").pool;exports.index=function(e,t,n){return t.render("app/index.jade")};exports.list=function(t,n,r){var i;i={id:+t.three.id};return e.getConnection(function(e,t){if(e){t.release();n.send(500);throw e}return t.query("SELECT * FROM `apps` WHERE `userId` = ?\nORDER BY `updatedAt` DESC, `identifier` ASC",[i.id],function(e,r){t.release();if(e){n.send(500);throw e}return n.render("app/list.jade",{apps:r})})})};exports.create=function(t,n,r){var i;i={name:t.param("name"),identifier:"",iconUrl:"",userId:+t.three.id,platform:""};if(i.name.trim().length===0){n.send(200,{code:400,message:"앱 이름은 1글자 이상이어야 합니다."});return}return e.getConnection(function(e,t){if(e){t.release();n.send(200,{code:500,message:"다시 시도해주세요."});throw e}return t.query("INSERT INTO `apps`\nSET ?, `updatedAt` = NOW()",[i],function(e,r){t.release();if(e){n.send(200,{code:500,message:"다시 시도해주세요."});throw e}return n.send(200,{code:200,id:r.insertId})})})};exports.find=function(t,n,r){var i;i={id:+t.param("appId")};if(!isFinite(i.id)){n.send(404);return}return e.getConnection(function(e,t){if(e){t.release();n.send(500);throw e}return t.query("SELECT * FROM `apps`\nWHERE `id` = ?",[i.id],function(e,r){t.release();return r.length?n.render("app/item.jade",{app:r[0]}):n.send(404)})})};exports.update=function(t,n,r){var i,s;s=t.param("appId");if(!isFinite(s)){({code:400,message:"앱 아이디를 찾을 수 없습니다."});return}i={name:t.param("name"),identifier:t.param("identifier"),iconUrl:"",platform:t.param("platform")};if(i.name.trim().length===0){n.send(200,{code:400,message:"앱 이름은 1글자 이상이어야 합니다."});return}return e.getConnection(function(e,r){if(e){r.release();n.send(200,{code:500,message:"다시 시도해주세요."});throw e}return r.query("SELECT COUNT(*) as `c` FROM `apps`\nWHERE `identifier` = ?\n  AND `platform` = ?\n  AND `userId` = ?\n  AND `id` != ?",[i.identifier,i.platform,+t.three.id,+s],function(e,o){if(e){r.release();n.send(200,{code:500,message:"다시 시도해주세요."});throw e}if(!o[0].c)return r.query("UPDATE `apps`\nSET ?, `updatedAt` = NOW()\nWHERE `id` = ?\n  AND `userId` = ?",[i,+s,+t.three.id],function(e,t){r.release();if(e){n.send(200,{code:500,message:"다시 시도해주세요."});throw e}return n.send(200,{code:200,timestamp:Date.now()})});r.release();n.send(200,{code:400,message:"앱 식별자가 중복됩니다."})})})};exports["delete"]=function(e,t,n){return t.send(501)}}).call(this);