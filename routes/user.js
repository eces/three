// Generated by CoffeeScript 1.6.3
(function(){var e,t,n;n=require("../db.js").pool;t=require("../activity.js");e=require("intl");exports.subscribe=function(e,t,r){var i;i=e.param("email");return n.getConnection(function(e,n){if(e){n.release();t.send({code:500,message:"다시 시도해주세요."});throw e}return n.query("INSERT INTO `subscriptions`\nSET `email` = ?, `createdAt` = NOW()",[i],function(e,n){if(e){t.send({code:500,message:"다시 시도해주세요."});throw e}return t.send({code:200})})})};exports.form=function(e,t,n){t.locals.promoCode=e.param("promo_code");return t.render("user/form.jade")};exports.index=function(t,r,i){var s;s={id:+t.param("userId")};if(t.three.id===void 0||t.three.id!==s.id){console.log(+t.three.id,s.id);r.send(404);return}return n.getConnection(function(t,n){var i,o,u;if(t){n.release();r.send(500);throw t}i=require("crypto");u=i.createHash("sha256");o=u.update("trp"+s.id).digest("hex");return n.query("SELECT *, (SELECT COUNT(`id`) FROM `users` WHERE `promo` = ?) as `promoted` FROM `users` WHERE `id` = ?",[o,s.id],function(t,i){if(t){n.release();r.send(500);throw t}if(i.length)return n.query("SELECT * FROM `activities`\nWHERE `userId` = ?\nORDER BY `id` DESC\nLIMIT 10",[s.id],function(t,s){var u;n.release();if(t){r.send(500);throw t}u=new e.NumberFormat("en-US",{style:"decimal",minimumFractionDigits:0});i[0].rateRemainsCurrency=u.format(i[0].rateRemains);i[0].rateLimitCurrency=u.format(i[0].rateLimit);r.render("user/index.jade",{user:i[0],activities:s,promoUrl:"/session?promo_code="+o})});n.release();r.send(404)})})};exports.signup=function(e,r){var i,s,o;o={};o.email=e.param("email");o.password=e.param("password");o.name=e.param("name");o.companyName="";o.phone="";o.companyPhone="";o.rateRemains=1e6;o.rateLimit=1e6;o.promo=e.param("promo");if(o.email.length===0||o.password.length===0||o.name.length===0){r.send({code:400,message:""});return}i=require("crypto");s=i.createHash("sha256");o.password=s.update(o.password).digest("hex");return n.getConnection(function(n,i){if(n){i.release();r.send({code:500,message:"이용자가 많거나 서버 점검중입니다. 문제가 지속될 경우 고객센터로 연락바랍니다."});throw n}return i.query("SELECT COUNT(*) as `c` FROM `users` WHERE `email` = ?",[o.email],function(n,s){if(n){i.release();r.send({code:500,message:"이용자가 많거나 서버 점검중입니다. 문제가 지속될 경우 고객센터로 연락바랍니다."});throw n}if(!s[0].c)return i.query("INSERT INTO `users` SET ?, `createdAt` = NOW()",o,function(n,s){i.release();if(n)throw n;if(s.insertId){e.three.id=s.insertId;e.three.name=o.name;e.three.email=o.email;t.create(e.three.id,"회원가입을 축하합니다.");t.create(e.three.id,"로그인됨"+t.getUserString(e));r.send({code:200,message:"환영합니다! 가입이 완료되었습니다.",id:e.three.id})}else r.send({code:500,message:"다시 시도해주세요. 문제가 지속될 경우 고객센터로 연락바랍니다."})});i.release();r.send({code:400,message:"이미 가입된 이메일 주소입니다."})})})};exports.signin=function(e,r){var i,s,o;o={};o.email=e.param("email");o.password=e.param("password");if(o.email.length===0||o.password.length===0){r.send({code:400,message:""});return}i=require("crypto");s=i.createHash("sha256");o.password=s.update(o.password).digest("hex");return n.getConnection(function(n,i){if(n){i.release();r.send({code:500,message:"이용자가 많거나 서버 점검중입니다. 문제가 지속될 경우 고객센터로 연락바랍니다."});throw n}return i.query("SELECT * FROM `users`\nWHERE `email` = ?",[o.email],function(n,s){if(n){i.release();r.send({code:500,message:"이용자가 많거나 서버 점검중입니다. 문제가 지속될 경우 고객센터로 연락바랍니다."});throw n}i.release();if(s.length)if(s[0].password===o.password){e.three.id=s[0].id;e.three.name=s[0].name;e.three.email=s[0].email;t.create(e.three.id,"로그인됨"+t.getUserString(e));r.send({code:200,id:e.three.id})}else r.send({code:400,message:"비밀번호가 틀립니다."});else r.send({code:400,message:"가입되지 않은 이름입니다."})})})};exports.signout=function(e,t){e.three={};return t.redirect("/")}}).call(this);