// Generated by CoffeeScript 1.6.3
(function(){var e,t,n,r;t=require("../db.js").pool;e=require("../activity.js");n=require("url");r="ko en zh-CN zh-TW ja".split(" ");exports.index=function(e,t,n){return t.render("message/index.jade")};exports.list=function(e,n,r){var i;i=+e.three.id;return t.getConnection(function(e,t){if(e){t.release();n.send(500);throw e}return t.query("SELECT `messages`.*, `apps`.`platform` as `appPlatform`, `apps`.`name` as `appName`\nFROM `messages`, `apps`\nWHERE `messages`.`userId` = ?\n  AND `messages`.`appId` = `apps`.`id`",[+i],function(e,r){t.release();if(e){n.send(500);throw e}return n.render("message/list.jade",{messages:r})})})};exports.create=function(e,n,r){var i,s;s=+e.three.id;i={appId:0,userId:s,identifier:"",name:e.param("name"),defaultLang:"en"};return t.getConnection(function(e,t){if(e){t.release();n.send(200,{code:500,message:"다시 시도해주세요."});throw e}return t.query("INSERT INTO `messages`\nSET ?, `createdAt` = NOW(), `updatedAt` = NOW()",[i],function(e,r){t.release();if(e){n.send(200,{code:500,message:"다시 시도해주세요."});throw e}return n.send(200,{code:200,id:r.insertId})})})};exports.find=function(e,n,i){var s,o;o=+e.three.id;s=e.param("messageId");if(!isFinite(s)){n.send(404);return}return t.getConnection(function(t,i){if(t){i.release();n.send(500);throw t}return i.query("SELECT * FROM `apps`\nWHERE `id` = ?",[o],function(t,u){if(t){i.release();n.send(500);throw t}return i.query("SELECT `messages`.*\nFROM `messages`\nWHERE `messages`.`id` = ?\n  AND `messages`.`userId` = ?",[s,o],function(t,s){var o;i.release();if(t){n.send(500);throw t}if(s.length){o=s[0].appId;return n.render("message/item.jade",{apps:u,message:s[0],languages:r,url:"/v1/users/"+e.three.id+"/apps/"+o+"/messages/"+s[0].identifier})}return n.send(404)})})})};exports.update=function(e,n,r){var i,s,o,u;u=+e.three.id;o=+e.param("messageId");i=+e.param("appId");s={appId:i,userId:u,identifier:e.param("identifier"),ko:e.param("ko"),en:e.param("en"),zh_CN:e.param("zh_CN"),zh_TW:e.param("zh_TW"),ja:e.param("ja"),name:e.param("name"),defaultLang:e.param("lang")};if(!isFinite(i)){n.send(200,{code:400,message:"앱 아이디를 찾을 수 없습니다."});return}if(!isFinite(o)){n.send(200,{code:400,message:"게시판 아이디를 찾을 수 없습니다."});return}return t.getConnection(function(e,t){if(e){t.release();n.send(200,{code:500,message:"다시 시도해주세요."});throw e}return t.query("SELECT COUNT(*) as `c`, `id`\nFROM `messages`\nWHERE `userId` = ?\n  AND `appId` = ?\n  AND `identifier` = ?",[u,i,s.identifier],function(e,r){if(e){t.release();n.send(200,{code:500,message:"다시 시도해주세요."});throw e}if(r[0].id===o||r[0].c===0)return t.query("UPDATE `messages`\nSET ?, `updatedAt` = NOW()\nWHERE `id` = ?\n  AND `userId` = ?",[s,o,u],function(e,r){t.release();if(e){n.send(200,{code:500,message:"다시 시도해주세요."});throw e}return n.send(200,{code:200,timestamp:Date.now()})});n.send(200,{code:400,message:"해당 앱에 같은 식별자를 가진 중복된 메시지가 있습니다. \n업데이트 취소."})})})};exports["delete"]=function(n,r,i){var s,o;o=+n.three.id;s=+n.param("messageId");if(!isFinite(s)){r.send(200,{code:400,message:"메시지 아이디를 찾을 수 없습니다."});return}return t.getConnection(function(t,i){if(t){i.release();r.send(200,{code:500,message:"다시 시도해주세요."});throw t}return i.query("DELETE FROM `messages`\nWHERE `id` = ?\n  AND `userId` = ?",[s,o],function(t,o){i.release();if(t){r.send(200,{code:500,message:"다시 시도해주세요."});throw t}if(o.affectedRows){e.create(n.three.id,"메시지 #"+s+" 삭제"+e.getUserString(n));return r.send(200,{code:200,timestamp:Date.now()})}r.send(200,{code:500,message:"다시 시도해주세요."});throw t})})};exports.view=function(e,r,i){var s,o,u,a;s=e.param("appId");a=e.param("userId");u=e.param("messageIdentifier");o=e.param("lang");isFinite(s)||r.send(400);return t.getConnection(function(e,t){if(e){t.release();r.send(500);throw e}return t.query("SELECT * FROM `messages`\nWHERE `appId` = ?\n  AND `userId` = ?\n  AND `identifier` = ?",[s,a,u],function(e,i){var s,u,a;t.release();if(e){r.send(500);throw e}if(i.length){u=i[0].defaultLang;o===void 0&&(o=u);s=i[0][o];if(s===void 0||s.length===0)s=i[0][u];if(s.startsWith("http")){a=n.parse(s);if(a.protocol!==null&&a.host!==null){r.redirect(302,s);return}}return r.send(200,s)}return r.send(404)})})}}).call(this);