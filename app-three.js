// Generated by CoffeeScript 1.6.3
(function(){var e,t,n,r,i,s,o,u,a,f,l,c;n=require("express");a={};a.user=require("./routes/user");a.app=require("./routes/app");a.board=require("./routes/board");a.post=require("./routes/post");a.message=require("./routes/message");a.resource=require("./routes/resource");a.feedback=require("./routes/feedback");a.report=require("./routes/report");r=require("http");s=require("path");o=require("./db.js").pool;c=require("client-sessions");f="@3aosJ3W30CS@OqgKcgi8Ax70lg;XGsH6;WW`Mc_VGP>G:ocbBhNPR;maPL6[[/[";String.prototype.endsWith=function(e){return this.substr(this.length-e.length)===e};String.prototype.startsWith=function(e){return this.substr(0,e.length)===e};e=n();module.exports=e;e.set("port",process.env.PORT||3010);e.enable("trust proxy");e.use(c({cookieName:"three-session",requestKey:"three",secret:f,duration:864e5,activeDuration:3e5,cookie:{ephemeral:!1,httpOnly:!0,secure:!1}}));e.use(function(t,n,r){var i,s;i=t.three.error;s=t.three.success;delete t.three.error;delete t.three.success;n.locals.error=i!==void 0?i:"";n.locals.message=s!==void 0?s:"";n.locals.signed=t.three.id!==void 0?!0:!1;if(n.locals.signed){n.locals.three={};+(n.locals.three.id=t.three.id);n.locals.three.email=t.three.email;n.locals.three.name=t.three.name}n.locals.moment=require("moment");n.locals.moment.lang("ko");n.locals.dev="development"===e.get("env")?!0:!1;return r()});if("development"===e.get("env")){e.use(n.logger("dev"));e.use(n.errorHandler())}else{i=require("newrelic");e.use(n.logger("tiny"))}e.use(n.bodyParser());e.use(n.methodOverride());e.use(n.cookieParser(f));e.use(n["static"](s.join(__dirname,"public")));e.engine("jade",require("jade").__express);e.use(e.router);u=function(e,t,n){if(e.three.id!==void 0)n();else{e.three.error="로그인 해주세요.";t.redirect("/")}};t=function(e,t,n){var r;r=e.param("userId");if(r===void 0||!isFinite(r))t.send(404);else{n();o.getConnection(function(e,t){if(e){t.release();console.log("[Error] decrementRate: req.path");return}return t.query("UPDATE `users` SET `rateRemains` = `rateRemains`-1\nWHERE `id` = ?",[+r],function(e,n){t.release();if(e)throw e})})}};e.get("/",function(e,t,n){t.locals.uri="/#";return t.render("index.jade")});e.post("/users/subscribe",function(e,t,n){return a.user.subscribe(e,t,n)});e.get("/users/:userId",function(e,t,n){t.locals.uri="/users";return a.user.index(e,t,n)});e.post("/users",function(e,t,n){return a.user.signup(e,t,n)});e.put("/users",u,function(e,t,n){return t.send(503)});e.get("/session",function(e,t,n){if(e.three.id!==void 0)return t.redirect("/users/"+e.three.id);t.locals.uri="/session";return a.user.form(e,t,n)});e.post("/session",function(e,t,n){return a.user.signin(e,t,n)});e.get("/session/destroy",u,function(e,t,n){return a.user.signout(e,t,n)});e.get("/apps",function(e,t,n){t.locals.uri="/apps";return e.three.id?a.app.list(e,t,n):a.app.index(e,t,n)});e.post("/apps",u,function(e,t,n){return a.app.create(e,t,n)});e.get("/apps/:appId",u,function(e,t,n){t.locals.uri="/apps";return a.app.find(e,t,n)});e.put("/apps/:appId",u,function(e,t,n){return a.app.update(e,t,n)});e["delete"]("/apps/:appId",u,function(e,t,n){return a.app["delete"](e,t,n)});e.get("/boards",function(e,t,n){t.locals.uri="/boards";return e.three.id?a.board.list(e,t,n):a.board.index(e,t,n)});e.get("/1",function(e,t){return t.render("board/view.jade")});e.post("/boards",u,function(e,t,n){return a.board.create(e,t,n)});e.get("/boards/:boardId",u,function(e,t,n){t.locals.uri="/boards";return a.board.find(e,t,n)});e.get("/boards/:boardId/preview",u,function(e,t,n){t.locals.uri="/boards";return a.board.preview(e,t,n)});e.post("/boards/:boardId/posts",u,function(e,t,n){return a.post.create(e,t,n)});e.put("/boards/:boardId",function(e,t,n){return a.board.update(e,t,n)});e.get("/boards/:boardId/posts",u,function(e,t,n){t.locals.uri="/boards";return a.post.list(e,t,n)});e.put("/boards/:boardId/posts/:postId",u,function(e,t,n){return a.post.update(e,t,n)});e["delete"]("/boards/:boardId/posts/:postId",u,function(e,t,n){return a.post["delete"](e,t,n)});e.get("/boards/:boardId/posts/:postId",u,function(e,t,n){t.locals.uri="/boards";return a.post.find(e,t,n)});e["delete"]("/boards/:boardId",u,function(e,t,n){return a.board["delete"](e,t,n)});e.get("/messages",function(e,t,n){t.locals.uri="/messages";return e.three.id?a.message.list(e,t,n):a.message.index(e,t,n)});e.post("/messages",u,function(e,t,n){return a.message.create(e,t,n)});e.get("/messages/:messageId",u,function(e,t,n){t.locals.uri="/messages";return a.message.find(e,t,n)});e.put("/messages/:messageId",u,function(e,t,n){return a.message.update(e,t,n)});e["delete"]("/messages/:messageId",u,function(e,t,n){return a.message["delete"](e,t,n)});e.get("/resources",function(e,t,n){t.locals.uri="/resources";return e.three.id?a.resource.list(e,t,n):a.resource.index(e,t,n)});e.get("/feedbacks",function(e,t,n){t.locals.uri="/feedbacks";return e.three.id?a.feedback.list(e,t,n):a.feedback.index(e,t,n)});e.get("/reports",function(e,t,n){t.locals.uri="/reports";return e.three.id?a.report.list(e,t,n):a.report.index(e,t,n)});e.get("/support",function(e,t,n){t.locals.uri="/support";return t.render("support/index.jade")});e.get("/docs",function(e,t){t.locals.uri="/docs";return t.render("document/index.jade")});e.get("/docs/:category/:title",function(e,t){var n,r;r=e.param("title");n=e.param("category");if(!/^[a-z]+$/i.test(n)||!/^[a-z0-9\-\_]+$/i.test(r)){t.render("document/404.jade");return}t.locals.uri="/docs/"+n+"/"+r;return t.render("document/"+n+"/"+r+".jade",function(e,n){return e?t.render("document/404.jade"):t.send(n)})});e.get("/v1/users/:userId/debug",t,function(e,t,n){return t.send(200)});e.get("/v1/users/:userId/apps/:appId/boards/:boardId",t,function(e,t,n){return a.board.view(e,t,n)});e.get("/v1/users/:userId/apps/:appId/messages/:messageIdentifier.:extension",t,function(e,t,n){return a.message.view(e,t,n)});e.get("/v1/users/:userId/apps/:appId/messages/:messageIdentifier",t,function(e,t,n){return a.message.view(e,t,n)});e.get("/v1/users/:userId/apps/:appId/files/:filename.:extension",t,function(e,t,n){return a.message.sendfile(e,t,n)});e.get("/v1/users/:userId/apps/:appId/files/:filename",t,function(e,t,n){return a.message.sendfile(e,t,n)});l=r.createServer(e);l.listen(e.get("port"),function(){return console.log("[app.js] Express server listening on port "+e.get("port"))})}).call(this);